<?xml version='1.0' encoding='utf-8'?>
<!--
  Dynamically generated by Puppet on <%= @fqdn %>

  Local modifications will be overwritten by Puppet.
--> 
<!DOCTYPE server-xml [
<% @global_resource_definitions.each do |resource| -%>
  <!ENTITY <%= resource %> SYSTEM "<%= resource %>.xml">
<%- end %>
<% @host_definitions.each do |host| -%>
  <!ENTITY <%= host %> SYSTEM "<%= host %>.xml">
<%- end %> 
]>
<Server port="<%= @instance_server_port %>" shutdown="SHUTDOWN">

<% if @balancer_name and @balancer_name!="" and @balancer_proxy_list and @balancer_proxy_list!= "" then -%>
  <!-- JBoss Mod_Cluster listener -->
  <Listener className="org.jboss.modcluster.container.catalina.standalone.ModClusterListener"
            loadMetricClass="org.jboss.modcluster.load.metric.impl.HeapMemoryUsageLoadMetric"
            stickySession="true"
            stickySessionRemove="true"
            stickySessionForce="false"
            nodeTimeout="7200"
            workerTimeout="30"
            maxAttempts="5"
            smax="3"
            proxyList="<% @balancer_proxy_list.each do |proxy| -%><%= "#{proxy}" %>,<%- end %>"
            balancer="<%= @balancer_name %>"
            loadBalancingGroup="<%= @balancer_name %>" />
<%- end %>

  <!-- APR library loader -->
  <Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" />

  <!-- Initialize Jasper prior to webapps are loaded -->
  <Listener className="org.apache.catalina.core.JasperListener" />

  <!-- Prevent memory leaks due to use of particular java/javax APIs -->
  <Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener" />
  <Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener" />
  <Listener className="org.apache.catalina.core.ThreadLocalLeakPreventionListener" />

  <GlobalNamingResources>
    <Resource name="UserDatabase" auth="Container"
              type="org.apache.catalina.UserDatabase"
              description="User database that can be updated and saved"
              factory="org.apache.catalina.users.MemoryUserDatabaseFactory"
              pathname="conf/tomcat-users.xml" />
<% @global_resource_definitions.each do |resource| -%>
    &<%= resource %>;
<%- end %>
  </GlobalNamingResources>

  <Service name="Catalina">
    <Connector port="<%= @instance_http_port %>" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="<%= @instance_https_port %>" />
    <Connector port="<%= @instance_ajp_port %>" protocol="AJP/1.3" redirectPort="<%= @instance_https_port %>" />
    <Engine name="Catalina" defaultHost="localhost" jvmRoute="${tomcat.jvmroute}">
      <!--
      <Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/>
      -->
      <Realm className="org.apache.catalina.realm.LockOutRealm">
        <Realm className="org.apache.catalina.realm.UserDatabaseRealm" resourceName="UserDatabase"/>
      </Realm>
      <Host name="localhost"  appBase="webapps" unpackWARs="true" autoDeploy="true" deployOnStartup="true">
        <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
               prefix="localhost_access_log." suffix=".txt"
               pattern="%h %l %u %t &quot;%r&quot; %s %b" />
      </Host>
<% @host_definitions.each do |host| %>
      &<%= host %>;
<%- end %>
    </Engine>
  </Service>
</Server>
